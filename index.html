<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>LOGIMASTER | GESTÃO DE FROTAS E LOGÍSTICA</title>
    
    <link rel="stylesheet" href="style.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body style="display:none;"> <div class="mobile-nav">
        <button id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <span class="logo-mobile">
            LOGI<span style="color:var(--primary-color);">MASTER</span>
        </span>
    </div>

    <header class="sidebar" id="sidebar">
        <div class="logo">
            LOGI<span style="color:var(--primary-color);">MASTER</span>
            <div style="font-size:0.4em; color:#78909c; letter-spacing:1px; margin-top:5px;">FROTA & LOGÍSTICA v8.0</div>
        </div>

        <div class="user-profile-summary" id="userProfileSidebar">
            <div class="avatar-circle"><i class="fas fa-user"></i></div>
            <div class="user-info">
                <span id="userEmailDisplay">carregando...</span>
                <small id="userRoleDisplay">...</small>
            </div>
            <button onclick="logoutSystem()" class="btn-logout-icon" title="Sair do Sistema">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <nav id="menu-admin" style="display:none;">
            <div class="nav-label">GESTÃO OPERACIONAL</div>
            <div class="nav-item active" data-page="home">
                <i class="fas fa-chart-pie"></i> DASHBOARD
            </div>
            <div class="nav-item" data-page="operacoes">
                <i class="fas fa-shipping-fast"></i> NOVA VIAGEM
            </div>
            <div class="nav-item" data-page="checkins-pendentes">
                <i class="fas fa-map-marked-alt"></i> MONITORAMENTO
            </div>
            
            <div class="nav-label">CADASTROS</div>
            <div class="nav-item" data-page="cadastros">
                <i class="fas fa-database"></i> CADASTROS GERAIS
            </div>
            
            <div class="nav-label">FINANCEIRO</div>
            <div class="nav-item" data-page="despesas">
                <i class="fas fa-money-bill-wave"></i> DESPESAS GERAIS
            </div>
            <div class="nav-item" data-page="recibos">
                <i class="fas fa-file-invoice-dollar"></i> RECIBOS & HOLERITE
            </div>
            <div class="nav-item" data-page="relatorios">
                <i class="fas fa-print"></i> RELATÓRIOS
            </div>
            
            <div class="nav-label">ADMINISTRAÇÃO</div>
            <div class="nav-item" data-page="access-management">
                <i class="fas fa-users-cog"></i> EQUIPE & AVISOS 
                <span id="badgeAccess" class="notification-badge" style="display:none">0</span>
            </div>
            <div class="nav-item" data-page="configuracoes">
                <i class="fas fa-cogs"></i> SISTEMA & BACKUP
            </div>
        </nav>

        <nav id="menu-employee" style="display:none;">
            <div class="nav-label">ÁREA DO COLABORADOR</div>
            <div class="nav-item active" data-page="employee-home">
                <i class="fas fa-tasks"></i> MEUS SERVIÇOS
            </div>
            <div class="nav-item" data-page="recibos">
                <i class="fas fa-file-invoice"></i> MEUS RECIBOS
            </div>
            <div class="nav-item" data-page="meus-dados">
                <i class="fas fa-id-card"></i> MEUS DADOS
            </div>
        </nav>

        <nav id="menu-super-admin" style="display:none;">
            <div class="nav-label">SUPER ADMIN</div>
            <div class="nav-item active" data-page="super-admin">
                <i class="fas fa-globe"></i> VISÃO GLOBAL
            </div>
        </nav>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <main class="content">
        
        <div id="home" class="page active">
            <div class="header-page">
                <div>
                    <h2><i class="fas fa-chart-line"></i> Painel Financeiro</h2>
                    <p>Visão geral de desempenho e custos</p>
                </div>
                <span class="date-display" id="currentDateDisplay"></span>
            </div>
            
            <div class="dashboard-cards">
                <div class="card-metric">
                    <div class="icon-metric" style="background: var(--primary-light); color: var(--primary-dark);">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div>
                        <h3>FATURAMENTO (MÊS)</h3>
                        <p class="value" id="faturamentoMes">R$ 0,00</p>
                    </div>
                </div>
                <div class="card-metric">
                    <div class="icon-metric" style="background: #ffcdd2; color: #c62828;">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div>
                        <h3>CUSTOS TOTAIS</h3>
                        <p class="value" id="despesasMes" style="color:var(--danger-color);">R$ 0,00</p>
                    </div>
                </div>
                <div class="card-metric">
                    <div class="icon-metric" style="background: #c8e6c9; color: #2e7d32;">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div>
                        <h3>LUCRO LÍQUIDO</h3>
                        <p class="value" id="receitaMes">R$ 0,00</p>
                    </div>
                </div>
                <div class="card-metric highlight">
                    <div class="icon-metric" style="background: #fff9c4; color: #fbc02d;">
                        <i class="fas fa-percent"></i>
                    </div>
                    <div>
                        <h3>MARGEM MÉDIA</h3>
                        <p class="value" id="margemLucroMedia">0%</p>
                    </div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <h3>Performance Financeira</h3>
                        <select id="filtroVeiculoGrafico" onchange="atualizarDashboard()" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
                            <option value="">Todos os Veículos</option>
                        </select>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
                
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn-mini" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="currentMonthYear">JANEIRO 2024</h3>
                        <button class="btn-mini" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-labels">
                        <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        </div>
                </div>
            </div>
        </div>

        <div id="operacoes" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-shipping-fast"></i> Gestão de Viagens</h2>
            </div>

             <div class="card">
                <div style="background: #e3f2fd; padding:15px; border-radius:6px; margin-bottom:20px; border-left:4px solid #2196f3;">
                    <h3 style="margin:0 0 10px 0; color:#1565c0;"><i class="fas fa-plus-circle"></i> Registrar / Agendar Operação</h3>
                    <p style="margin:0; font-size:0.9rem;">Preencha os dados abaixo para lançar uma nova viagem ou agendar para a equipe.</p>
                </div>

                <form id="formOperacao" class="form-grid">
                    <input type="hidden" id="operacaoId">
                    
                    <div class="form-col full">
                        <label class="checkbox-container-custom">
                            <input type="checkbox" id="operacaoIsAgendamento">
                            <span class="checkmark"></span>
                            <strong>AGENDAMENTO FUTURO (Criar rota para motorista fazer check-in)</strong>
                        </label>
                    </div>

                    <div class="form-col">
                        <label>Data da Viagem</label>
                        <input type="date" id="operacaoData" required>
                    </div>
                    <div class="form-col">
                        <label>Motorista Responsável</label>
                        <select id="selectMotoristaOperacao" required></select>
                    </div>
                    <div class="form-col">
                        <label>Veículo Utilizado</label>
                        <select id="selectVeiculoOperacao" required></select>
                    </div>
                    <div class="form-col">
                        <label>Cliente / Contratante</label>
                        <select id="selectContratanteOperacao" required></select>
                    </div>
                    <div class="form-col">
                        <label>Atividade / Tipo de Serviço</label>
                        <select id="selectAtividadeOperacao" required></select>
                    </div>
                    
                    <div class="form-col full"><hr></div>

                    <div class="form-col">
                        <label>Faturamento Total (R$)</label>
                        <input type="number" step="0.01" id="operacaoFaturamento" required placeholder="0,00">
                    </div>
                    <div class="form-col">
                        <label>Adiantamento (R$)</label>
                        <input type="number" step="0.01" id="operacaoAdiantamento" value="0">
                    </div>
                    <div class="form-col">
                        <label>Comissão Motorista (R$)</label>
                        <input type="number" step="0.01" id="operacaoComissao" value="0">
                    </div>
                    <div class="form-col">
                        <label>Despesas Extras/Pedágio (R$)</label>
                        <input type="number" step="0.01" id="operacaoDespesas" value="0">
                    </div>
                    
                    <div class="form-col full"><hr></div>

                    <div class="form-col">
                        <label>Abastecimento (R$)</label>
                        <input type="number" step="0.01" id="operacaoCombustivel" value="0">
                    </div>
                    <div class="form-col">
                        <label>Preço Litro (Opcional)</label>
                        <input type="number" step="0.01" id="operacaoPrecoLitro" value="0" placeholder="Ex: 5.89">
                    </div>
                    <div class="form-col">
                        <label>KM Rodado (Total)</label>
                        <input type="number" step="0.1" id="operacaoKmRodado" value="0">
                    </div>
                    
                    <div class="form-col full" style="background:#f9f9f9; padding:15px; border-radius:6px; border:1px solid #eee;">
                        <label style="color:#00796b; font-weight:bold;">Adicionar Ajudantes / Chapas</label>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <select id="selectAjudantesOperacao" style="flex:1;"></select>
                            <button type="button" class="btn-primary" id="btnManualAddAjudante"><i class="fas fa-user-plus"></i> ADD</button>
                        </div>
                        <ul id="listaAjudantesAdicionados" style="margin-top:10px; list-style:none; padding:0;">
                            </ul>
                    </div>

                    <div class="form-col full" style="margin-top:20px;">
                        <button type="submit" class="btn-success" style="width:100%; padding:15px; font-size:1.1rem; font-weight:bold;">
                            <i class="fas fa-save"></i> SALVAR OPERAÇÃO
                        </button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top:30px;">
                <div class="card-header-flex">
                    <h3>Histórico Recente de Viagens</h3>
                    <input type="text" placeholder="Filtrar..." style="padding:5px; border:1px solid #ccc; border-radius:4px;">
                </div>
                <div class="table-responsive">
                    <table id="tabelaOperacoes" class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Motorista / Veículo</th>
                                <th>Status</th>
                                <th>Faturamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="checkins-pendentes" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-map-marked-alt"></i> Monitoramento em Tempo Real</h2>
            </div>
            
            <div class="card">
                <h3>Status da Frota e Equipe</h3>
                <p>Acompanhe o check-in dos motoristas e ajudantes nas rotas agendadas.</p>
                <div class="table-responsive">
                    <table id="tabelaCheckinsPendentes" class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Veículo</th>
                                <th>Equipe (Check-in)</th>
                                <th>Status Operacional</th>
                                <th>Mapa</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top:30px; border-top: 4px solid #c62828;">
                <h3 style="color:#c62828;"><i class="fas fa-exclamation-triangle"></i> Registro de Faltas</h3>
                <p>Funcionários que não compareceram às operações agendadas.</p>
                <div class="table-responsive">
                    <table id="tabelaFaltas" class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Funcionário</th>
                                <th>Função</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="cadastros" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-database"></i> Cadastros Gerais</h2>
            </div>

            <div class="tabs-container">
                <button class="cadastro-tab-btn active" data-tab="funcionarios"><i class="fas fa-users"></i> Funcionários</button>
                <button class="cadastro-tab-btn" data-tab="veiculos"><i class="fas fa-truck"></i> Veículos</button>
                <button class="cadastro-tab-btn" data-tab="contratantes"><i class="fas fa-building"></i> Clientes</button>
                <button class="cadastro-tab-btn" data-tab="atividades"><i class="fas fa-box"></i> Atividades</button>
                <button class="cadastro-tab-btn" data-tab="minha-empresa"><i class="fas fa-id-badge"></i> Minha Empresa</button>
            </div>

            <div id="funcionarios" class="cadastro-form active">
                <div class="card">
                    <h3>Novo Funcionário</h3>
                    <form id="formFuncionario" class="form-grid">
                        <input type="hidden" id="funcionarioId">
                        
                        <div class="form-col">
                            <label>Nome Completo</label>
                            <input type="text" id="funcNome" required style="text-transform:uppercase;">
                        </div>
                        <div class="form-col">
                            <label>Função</label>
                            <select id="funcFuncao" required onchange="toggleDriverFields()">
                                <option value="motorista">Motorista</option>
                                <option value="ajudante">Ajudante</option>
                                <option value="operacional">Operacional</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>CPF/RG</label>
                            <input type="text" id="funcDocumento" required>
                        </div>
                        <div class="form-col">
                            <label>Email (Login)</label>
                            <input type="email" id="funcEmail" required placeholder="email@exemplo.com">
                        </div>
                        <div class="form-col">
                            <label>Senha (Acesso)</label>
                            <input type="text" id="funcSenha" placeholder="Deixe vazio para manter atual">
                        </div>
                        <div class="form-col">
                            <label>Telefone/WhatsApp</label>
                            <input type="text" id="funcTelefone">
                        </div>
                        <div class="form-col">
                            <label>Chave PIX</label>
                            <input type="text" id="funcPix">
                        </div>
                        <div class="form-col full">
                            <label>Endereço Completo</label>
                            <input type="text" id="funcEndereco">
                        </div>
                        
                        <div id="driverSpecificFields" class="form-col full" style="background:#f1f8e9; padding:15px; border-radius:6px; border:1px dashed #aed581; margin-top:10px;">
                            <h4 style="margin-top:0; color:#33691e;"><i class="fas fa-id-card"></i> Dados da CNH (Motorista)</h4>
                            <div class="form-grid">
                                <div class="form-col"><label>Nº Registro CNH</label><input type="text" id="funcCNH"></div>
                                <div class="form-col"><label>Validade</label><input type="date" id="funcValidadeCNH"></div>
                                <div class="form-col"><label>Categoria</label><input type="text" id="funcCategoriaCNH" placeholder="Ex: AD, AE"></div>
                                <div class="form-col full"><label>Cursos (MOPP, Cargas Indivisíveis...)</label><input type="text" id="funcCursoDescricao"></div>
                            </div>
                        </div>

                        <div class="form-col full" style="margin-top:15px;">
                            <button type="submit" class="btn-success" style="width:100%;"><i class="fas fa-save"></i> SALVAR FUNCIONÁRIO</button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Lista de Colaboradores</h3>
                    <table id="tabelaFuncionarios" class="data-table">
                        <thead><tr><th>Nome</th><th>Função</th><th>Email</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="veiculos" class="cadastro-form">
                <div class="card">
                    <form id="formVeiculo" class="form-grid">
                        <div class="form-col"><label>Placa</label><input type="text" id="veiculoPlaca" required></div>
                        <div class="form-col"><label>Modelo</label><input type="text" id="veiculoModelo" required></div>
                        <div class="form-col"><label>Ano</label><input type="number" id="veiculoAno"></div>
                        <div class="form-col"><label>Renavam</label><input type="text" id="veiculoRenavam"></div>
                        <div class="form-col"><label>Chassi</label><input type="text" id="veiculoChassi"></div>
                        <div class="form-col full"><button type="submit" class="btn-success">SALVAR VEÍCULO</button></div>
                    </form>
                </div>
                <div class="card">
                    <table id="tabelaVeiculos" class="data-table">
                        <thead><tr><th>Placa</th><th>Modelo</th><th>Ano</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="contratantes" class="cadastro-form">
                <div class="card">
                    <form id="formContratante" class="form-grid">
                        <div class="form-col"><label>CNPJ</label><input type="text" id="contratanteCNPJ" required></div>
                        <div class="form-col"><label>Razão Social</label><input type="text" id="contratanteRazaoSocial" required></div>
                        <div class="form-col"><label>Telefone</label><input type="text" id="contratanteTelefone"></div>
                        <div class="form-col full"><button type="submit" class="btn-success">SALVAR CLIENTE</button></div>
                    </form>
                </div>
                <div class="card">
                    <table id="tabelaContratantes" class="data-table">
                        <thead><tr><th>Razão Social</th><th>CNPJ</th><th>Tel</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="atividades" class="cadastro-form">
                <div class="card">
                    <form id="formAtividade" class="form-grid">
                        <input type="hidden" id="atividadeId">
                        <div class="form-col full"><label>Nome do Serviço / Rota</label><input type="text" id="atividadeNome" required></div>
                        <div class="form-col full"><button type="submit" class="btn-success">SALVAR ATIVIDADE</button></div>
                    </form>
                </div>
                <div class="card">
                    <table id="tabelaAtividades" class="data-table">
                        <thead><tr><th>ID</th><th>Nome</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="minha-empresa" class="cadastro-form">
                <div class="card">
                    <h3>Dados da Transportadora</h3>
                    <form id="formMinhaEmpresa" class="form-grid">
                        <div class="form-col"><label>Razão Social</label><input type="text" id="minhaEmpresaRazaoSocial"></div>
                        <div class="form-col"><label>CNPJ</label><input type="text" id="minhaEmpresaCNPJ"></div>
                        <div class="form-col"><label>Telefone</label><input type="text" id="minhaEmpresaTelefone"></div>
                        <div class="form-col full"><button type="submit" class="btn-primary">ATUALIZAR DADOS DA EMPRESA</button></div>
                    </form>
                    
                    <div id="viewMinhaEmpresaContent" style="margin-top:20px; padding:15px; background:#eee; border-radius:6px;">
                        </div>

                    <div style="margin-top:50px; border-top:2px solid #ffcdd2; padding-top:20px;">
                        <h4 style="color:red;"><i class="fas fa-skull-crossbones"></i> ZONA DE PERIGO</h4>
                        <p>Ações irreversíveis de gerenciamento de dados.</p>
                        <button onclick="resetSystemData()" class="btn-danger" style="width:100%; padding:15px;">
                            ZERAR TODO O SISTEMA (DEEP WIPE)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="despesas" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-money-bill-wave"></i> Controle de Despesas Gerais</h2>
            </div>
            
            <div class="card">
                <h3>Lançamento de Despesa</h3>
                <form id="formDespesaGeral" class="form-grid">
                    <div class="form-col">
                        <label>Data</label>
                        <input type="date" id="despesaGeralData" required>
                    </div>
                    <div class="form-col">
                        <label>Veículo (Opcional)</label>
                        <select id="selectVeiculoDespesaGeral"></select>
                    </div>
                    <div class="form-col full">
                        <label>Descrição da Despesa</label>
                        <input type="text" id="despesaGeralDescricao" required placeholder="Ex: Compra de Peças, Aluguel do Pátio...">
                    </div>
                    <div class="form-col">
                        <label>Valor (R$)</label>
                        <input type="number" step="0.01" id="despesaGeralValor" required>
                    </div>
                    <div class="form-col">
                        <label>Forma Pagamento</label>
                        <select id="despesaFormaPagamento">
                            <option>Dinheiro</option>
                            <option>PIX</option>
                            <option>Cartão Crédito</option>
                            <option>Cartão Débito</option>
                            <option>Boleto</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Modo</label>
                        <select id="despesaModoPagamento" onchange="toggleDespesaParcelas()">
                            <option value="avista">À Vista</option>
                            <option value="parcelado">Parcelado</option>
                        </select>
                    </div>
                    
                    <div class="form-col" id="divDespesaParcelas" style="display:none;">
                        <label>Parcelas (Ex: 1/10)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="despesaParcelasPagas" value="1" placeholder="Paga">
                            <span style="align-self:center;">de</span>
                            <input type="number" id="despesaParcelas" value="1" placeholder="Total">
                        </div>
                    </div>
                    
                    <div class="form-col full">
                        <button type="submit" class="btn-success" style="width:100%;">LANÇAR DESPESA</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <h3>Histórico de Despesas</h3>
                <table id="tabelaDespesasGerais" class="data-table">
                    <thead><tr><th>Data</th><th>Ref.</th><th>Descrição</th><th>Valor</th><th>Pagto</th><th>Ação</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="recibos" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-file-invoice-dollar"></i> Recibos e Holerites</h2>
            </div>

            <div id="adminRecibosPanel">
                <div class="card">
                    <h3>Gerar Novo Recibo</h3>
                    <div class="form-grid">
                        <div class="form-col">
                            <label>Funcionário</label>
                            <select id="selectMotoristaRecibo"></select>
                        </div>
                        <div class="form-col">
                            <label>Início Período</label>
                            <input type="date" id="dataInicioRecibo">
                        </div>
                        <div class="form-col">
                            <label>Fim Período</label>
                            <input type="date" id="dataFimRecibo">
                        </div>
                        <div class="form-col">
                            <button class="btn-primary" onclick="gerarReciboPagamento()" style="margin-top:22px; width:100%;">
                                <i class="fas fa-magic"></i> GERAR PRÉVIA
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>Histórico de Recibos Gerados</h3>
                    <table id="tabelaHistoricoRecibos" class="data-table">
                        <thead><tr><th>Emissão</th><th>Funcionário</th><th>Período</th><th>Valor</th><th>Enviado?</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="employeeRecibosPanel" style="display:none;">
                <div class="card">
                    <h3>Meus Demonstrativos de Pagamento</h3>
                    <p>Aqui ficam armazenados seus recibos aprovados.</p>
                    <table id="tabelaMeusRecibos" class="data-table">
                        <thead><tr><th>Data</th><th>Referência</th><th>Valor Líquido</th><th>Ver</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="relatorios" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-print"></i> Relatórios Gerenciais</h2>
            </div>
            
            <div class="card no-print">
                <h3>Filtros de Pesquisa</h3>
                <div class="form-grid">
                    <div class="form-col">
                        <label>Data Início</label>
                        <input type="date" id="dataInicioRelatorio">
                    </div>
                    <div class="form-col">
                        <label>Data Fim</label>
                        <input type="date" id="dataFimRelatorio">
                    </div>
                    <div class="form-col">
                        <label>Motorista/Ajudante (Opcional)</label>
                        <select id="selectMotoristaRelatorio"></select>
                    </div>
                    <div class="form-col">
                        <label>Veículo (Opcional)</label>
                        <select id="selectVeiculoRelatorio"></select>
                    </div>
                    <div class="form-col">
                        <label>Cliente (Opcional)</label>
                        <select id="selectContratanteRelatorio"></select>
                    </div>
                    <div class="form-col">
                        <label>Atividade (Opcional)</label>
                        <select id="selectAtividadeRelatorio"></select>
                    </div>
                    <div class="form-col full" style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn-primary" onclick="gerarRelatorioGeral()" style="flex:1;">
                            <i class="fas fa-table"></i> RELATÓRIO GERAL / PAGAMENTOS
                        </button>
                        <button class="btn-warning" onclick="gerarRelatorioCobranca()" style="flex:1;">
                            <i class="fas fa-file-invoice"></i> FATURA CLIENTE (COBRANÇA)
                        </button>
                    </div>
                </div>
            </div>

            <div id="reportResults" class="card" style="display:none;">
                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <button class="btn-mini no-print" onclick="exportarRelatorioPDF()">
                        <i class="fas fa-file-pdf"></i> SALVAR EM PDF
                    </button>
                </div>
                <div id="reportContent">
                    </div>
            </div>
        </div>

        <div id="access-management" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-users-cog"></i> Gestão de Acesso & Equipe</h2>
            </div>
            
            <div class="card">
                <h3 style="color:#f57f17;"><i class="fas fa-user-clock"></i> Solicitações de Cadastro (Login)</h3>
                <p>Usuários que criaram conta na tela de login e aguardam sua aprovação.</p>
                <div class="table-responsive">
                    <table id="tabelaCompanyPendentes" class="data-table">
                        <thead><tr><th>Nome</th><th>Email</th><th>Função Solicitada</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-user-check"></i> Usuários Ativos (Vinculados)</h3>
                <p>Membros da equipe com acesso liberado ao sistema.</p>
                <div class="table-responsive">
                    <table id="tabelaCompanyAtivos" class="data-table">
                        <thead><tr><th>Nome</th><th>Email</th><th>Função</th><th>Vínculo</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-sync"></i> Solicitações de Alteração de Dados</h3>
                <p>Pedidos de atualização de telefone, endereço ou documentos.</p>
                <div class="table-responsive">
                    <table id="tabelaProfileRequests" class="data-table">
                        <thead><tr><th>Data</th><th>Funcionário</th><th>Campo</th><th>Novo Valor</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="configuracoes" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-cogs"></i> Sistema e Segurança</h2>
            </div>
            <div class="card">
                <h3>Backup Manual dos Dados</h3>
                <p>Gere um arquivo JSON com todos os dados locais do seu navegador para segurança.</p>
                <button class="btn-primary" onclick="exportDataBackup()">
                    <i class="fas fa-download"></i> BAIXAR BACKUP (JSON)
                </button>
                
                <hr style="margin:20px 0;">
                
                <h3>Restaurar Dados</h3>
                <label>Selecione o arquivo de backup (.json):</label>
                <br>
                <input type="file" onchange="importDataBackup(event)">
            </div>
        </div>

        <div id="employee-home" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-tasks"></i> Minhas Viagens e Tarefas</h2>
            </div>
            
            <div id="listaServicosAgendados"></div>
            
            <div class="card" style="margin-top:30px;">
                <h3>Meu Histórico</h3>
                <div class="form-grid">
                    <div class="form-col"><label>Início</label><input type="date" id="empDataInicio"></div>
                    <div class="form-col"><label>Fim</label><input type="date" id="empDataFim"></div>
                    <div class="form-col">
                        <button class="btn-primary" style="margin-top:22px; width:100%;" onclick="filtrarHistoricoFuncionario()">FILTRAR</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="tabelaHistoricoCompleto" class="data-table">
                        <thead><tr><th>Data</th><th>Veículo</th><th>Cliente</th><th>Valor</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="text-align:right; font-size:1.2rem; font-weight:bold; margin-top:10px; padding:10px; background:#e8f5e9; border-radius:6px;">
                    Total no Período: <span id="empTotalReceber" style="color:green;">R$ 0,00</span>
                </div>
            </div>
        </div>

        <div id="meus-dados" class="page" style="display:none;">
            </div>

        <div id="super-admin" class="page" style="display:none;">
            <div class="header-page">
                <h2><i class="fas fa-globe"></i> Painel Super Admin</h2>
            </div>
            
            <div class="super-search-box">
                <i class="fas fa-search" style="color:#aaa; margin-right:10px;"></i>
                <input type="text" id="superAdminSearch" placeholder="Buscar empresa, domínio ou email..." onkeyup="filterGlobalUsers()" style="border:none; outline:none; width:100%;">
                <button class="btn-mini btn-primary" onclick="carregarPainelSuperAdmin(true)">ATUALIZAR</button>
            </div>
            
            <div id="superAdminContainer" class="hierarchy-container">
                </div>
        </div>

    </main>

    <div id="modalNotification" class="modal">
        <div class="modal-content" style="text-align:center;">
            <div style="font-size:3rem; color:var(--primary-color); margin-bottom:10px;">
                <i class="fas fa-bell"></i>
            </div>
            <h3>Nova Mensagem</h3>
            <p id="notificationSender" style="font-weight:bold; color:#555;"></p>
            <p id="notificationMessageText" style="font-size:1.1rem; margin:15px 0; background:#f5f5f5; padding:10px; border-radius:6px;"></p>
            <div class="modal-actions">
                <button class="btn-primary" onclick="confirmarLeituraMensagem()">ENTENDIDO</button>
            </div>
        </div>
    </div>
    
    <div id="viewItemModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 id="viewItemTitle" style="margin:0;">Detalhes</h3>
                <button class="btn-mini delete-btn" onclick="closeViewModal()">X</button>
            </div>
            <div id="viewItemBody"></div>
        </div>
    </div>

    <div id="modalRecibo" class="modal" style="z-index:9999;">
        <div class="modal-content" style="max-width:850px;">
            <div id="modalReciboContent"></div>
            <div id="modalReciboActions" class="modal-actions" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; text-align:right;"></div>
        </div>
    </div>

    <div id="modalDayOperations" class="modal">
        <div class="modal-content" style="max-width:900px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 id="modalDayTitle"></h3>
                <button class="btn-mini delete-btn" onclick="document.getElementById('modalDayOperations').style.display='none'">X</button>
            </div>
            <div id="modalDaySummary"></div>
            <div id="modalDayBody"></div>
        </div>
    </div>
    
    <div id="modalRequestProfileChange" class="modal">
        <div class="modal-content">
            <h3>Solicitar Alteração Cadastral</h3>
            <p>O administrador precisará aprovar esta mudança.</p>
            <form id="formRequestProfileChange">
                <div class="form-grid">
                    <div class="form-col full">
                        <label>O que deseja alterar?</label>
                        <select id="reqFieldType" required>
                            <option value="TELEFONE">Telefone</option>
                            <option value="ENDERECO">Endereço</option>
                            <option value="PIX">Chave PIX</option>
                            <option value="CNH">Número da CNH</option>
                            <option value="VALIDADE_CNH">Validade CNH</option>
                            <option value="EMAIL">Email de Acesso</option>
                        </select>
                    </div>
                    <div class="form-col full">
                        <label>Novo Valor</label>
                        <input type="text" id="reqNewValue" required>
                    </div>
                    <div class="form-col full" style="display:flex; gap:10px; margin-top:15px;">
                        <button type="submit" class="btn-success" style="flex:1;">ENVIAR SOLICITAÇÃO</button>
                        <button type="button" class="btn-secondary" onclick="document.getElementById('modalRequestProfileChange').style.display='none'">CANCELAR</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modalAdicionarAjudante" class="modal">
        <div class="modal-content">
             <h3>Adicionar Ajudante</h3>
             </div>
    </div>
    
    <div id="modalCheckinConfirm" class="modal">
        <div class="modal-content">
             <h3>Confirmar Check-in</h3>
             <p>Deseja confirmar sua presença nesta viagem?</p>
             <div class="modal-actions">
                 <button class="btn-success" id="btnConfirmCheckinAction">CONFIRMAR</button>
                 <button class="btn-secondary" onclick="closeCheckinConfirmModal()">CANCELAR</button>
             </div>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      // ----------------------------------------------------------------------------------
      // CONFIGURAÇÃO DO FIREBASE (Chaves fornecidas)
      // ----------------------------------------------------------------------------------
      const firebaseConfig = {
          apiKey: "AIzaSyBZjVdcyjbEoR_-X6_lZuTRDMeN2wIntZI",
          authDomain: "logi-master-dd4cd.firebaseapp.com",
          projectId: "logi-master-dd4cd",
          storageBucket: "logi-master-dd4cd.firebasestorage.app",
          messagingSenderId: "673000154258",
          appId: "1:673000154258:web:fc9d6fced43e557076324b"
      };

      // Inicializa Firebase
      let app, auth, db;
      
      try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);

          // Salva no LocalStorage para que o login.html possa usar sem hardcoding se quiser
          localStorage.setItem('firebase_config_cache', JSON.stringify(firebaseConfig));

          // Expõe referências globais para o script.js usar
          window.dbRef = { 
              app, auth, db, 
              doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc, deleteDoc, writeBatch,
              createUserWithEmailAndPassword // Exposto para funções antigas se necessário
          };

          // Monitor de Autenticação
          onAuthStateChanged(auth, async (user) => {
              if (user) {
                  try {
                      // Busca dados do Firestore
                      const userSnap = await getDoc(doc(db, "users", user.uid));
                      
                      if (userSnap.exists()) {
                          const userData = userSnap.data();
                          
                          // Verifica aprovação
                          if (userData.approved === false) {
                             alert("Seu cadastro foi criado, mas aguarda aprovação do administrador.\n\nPor favor, contate seu gerente.");
                             await signOut(auth);
                             window.location.replace("login.html");
                             return;
                          }

                          window.USUARIO_ATUAL = userData; // Define globalmente
                          document.body.style.display = 'flex'; // Mostra o corpo
                          
                          const emailElem = document.getElementById('userEmailDisplay');
                          const roleElem = document.getElementById('userRoleDisplay');
                          if(emailElem) emailElem.textContent = userData.email.toUpperCase();
                          if(roleElem) roleElem.textContent = userData.role.toUpperCase();
                          
                          // Inicializa o sistema principal (Função definida no script.js)
                          setTimeout(() => { 
                              if (window.initSystemByRole) window.initSystemByRole(userData); 
                          }, 500);

                      } else {
                          // Usuário autenticado mas sem registro no Firestore
                          alert("Erro de consistência: Usuário sem perfil. Entre em contato com o suporte.");
                          await signOut(auth);
                          window.location.replace("login.html");
                      }
                  } catch (err) {
                      console.error("Erro auth state:", err);
                      // Opcional: não redirecionar imediatamente em caso de erro de rede
                  }
              } else { 
                  // Não logado
                  if(!window.location.href.includes('login.html')) {
                      window.location.replace("login.html");
                  }
              }
          });
      } catch (e) {
          console.error("Erro ao inicializar Firebase:", e);
          alert("Erro crítico na conexão com o banco de dados.");
      }
      
      window.logoutSystem = async function() {
          if(auth) await signOut(auth);
          window.location.href = "login.html";
      }
    </script>
    
    <script src="script.js" defer></script>
</body>
</html>