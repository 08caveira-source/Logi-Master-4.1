<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGIMASTER | SISTEMA</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body style="display:none;"> <div class="sidebar">
        <div class="logo">LOGI<span style="color:var(--primary-light)">MASTER</span></div>
        <div class="user-info">
            <i class="fas fa-user-circle fa-2x"></i>
            <p id="userEmailDisplay">...</p>
            <span id="userRoleDisplay" class="pill pending">...</span>
        </div>
        
        <nav id="menuAdmin" style="display:none;">
            <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-chart-line"></i> DASHBOARD</div>
            <div class="nav-item" onclick="navTo('operacoes')"><i class="fas fa-truck"></i> OPERAÇÕES</div>
            <div class="nav-item" onclick="navTo('equipe')"><i class="fas fa-users"></i> EQUIPE & AVISOS</div>
            <div class="nav-item" onclick="navTo('cadastros')"><i class="fas fa-database"></i> CADASTROS</div>
            <div class="nav-item" onclick="navTo('despesas')"><i class="fas fa-money-bill-wave"></i> DESPESAS</div>
            <div class="nav-item" onclick="navTo('relatorios')"><i class="fas fa-file-alt"></i> RELATÓRIOS</div>
            <div class="nav-item" onclick="navTo('config')"><i class="fas fa-cogs"></i> CONFIGURAÇÕES</div>
        </nav>
        
        <nav id="menuFunc" style="display:none;">
            <div class="nav-item active" onclick="navTo('func-home')"><i class="fas fa-home"></i> MEU PAINEL</div>
            <div class="nav-item" onclick="navTo('func-dados')"><i class="fas fa-id-card"></i> MEUS DADOS</div>
        </nav>

        <div class="sidebar-footer">
            <button class="btn-danger" style="width:100%" onclick="logout()"><i class="fas fa-sign-out-alt"></i> SAIR</button>
        </div>
    </div>

    <div class="content">
        
        <section id="home" class="page active">
            <h2>DASHBOARD</h2>
            <div class="card-grid">
                <div class="card stat-card success"><h3>R$ <span id="dashFat">0,00</span></h3><p>FATURAMENTO</p></div>
                <div class="card stat-card danger"><h3>R$ <span id="dashCust">0,00</span></h3><p>CUSTOS</p></div>
                <div class="card stat-card primary"><h3>R$ <span id="dashLucro">0,00</span></h3><p>LUCRO LÍQUIDO</p></div>
            </div>
            
            <div class="card">
                <h3><i class="far fa-calendar-alt"></i> CALENDÁRIO DE OPERAÇÕES</h3>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <button class="btn-secondary btn-mini" onclick="mudarMes(-1)">ANTERIOR</button>
                    <strong id="mesAnoDisplay" style="font-size:1.2rem;">...</strong>
                    <button class="btn-secondary btn-mini" onclick="mudarMes(1)">PRÓXIMO</button>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </section>

        <section id="operacoes" class="page">
            <h2>LANÇAR OPERAÇÃO</h2>
            <div class="card">
                <form id="formOperacao">
                    <input type="hidden" id="opId">
                    <div class="form-row">
                        <div class="form-col"><label>DATA:</label><input type="date" id="opData" required></div>
                        <div class="form-col"><label>MOTORISTA:</label><select id="opMotorista" required></select></div>
                        <div class="form-col"><label>VEÍCULO:</label><select id="opVeiculo" required></select></div>
                        <div class="form-col"><label>CLIENTE:</label><select id="opCliente" required></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><label style="color:green">FATURAMENTO (R$):</label><input type="number" step="0.01" id="opFat"></div>
                        <div class="form-col"><label style="color:red">COMBUSTÍVEL (R$):</label><input type="number" step="0.01" id="opComb"></div>
                        <div class="form-col"><label>OUTRAS DESPESAS:</label><input type="number" step="0.01" id="opDesp"></div>
                        <div class="form-col"><label>STATUS:</label>
                            <select id="opStatus">
                                <option value="AGENDADA">AGENDADA</option>
                                <option value="CONFIRMADA">CONFIRMADA (FINALIZADA)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><label>AJUDANTES:</label><input type="text" id="opAjudantesInput" placeholder="Nomes separados por vírgula"></div>
                    </div>
                    <button type="submit" class="btn-primary"><i class="fas fa-save"></i> SALVAR OPERAÇÃO</button>
                    <button type="button" class="btn-secondary" onclick="limparFormOp()">NOVA</button>
                </form>
            </div>
            
            <div class="card">
                <h3>HISTÓRICO RECENTE</h3>
                <table>
                    <thead><tr><th>DATA</th><th>CLIENTE</th><th>VEÍCULO/MOT.</th><th>STATUS</th><th>VALOR</th><th>AÇÕES</th></tr></thead>
                    <tbody id="tabelaOperacoes"></tbody>
                </table>
            </div>
        </section>

        <section id="equipe" class="page">
            <h2>EQUIPE & COMUNICAÇÃO</h2>
            <div class="card" style="border-left: 5px solid orange;">
                <h3><i class="fas fa-bullhorn"></i> ENVIAR AVISO PARA EQUIPE</h3>
                <form id="formAviso">
                    <div class="form-row">
                        <div class="form-col"><label>MENSAGEM:</label><textarea id="avisoTexto" rows="3" placeholder="Digite o aviso para todos..." required></textarea></div>
                    </div>
                    <button type="submit" class="btn-warning"><i class="fas fa-paper-plane"></i> ENVIAR AVISO</button>
                </form>
            </div>
            <div class="card">
                <h3>LISTA DE FUNCIONÁRIOS</h3>
                <table>
                    <thead><tr><th>NOME</th><th>FUNÇÃO</th><th>EMAIL</th><th>AÇÕES</th></tr></thead>
                    <tbody id="tabelaEquipeFull"></tbody>
                </table>
            </div>
        </section>

        <section id="cadastros" class="page">
            <h2>GESTÃO DE CADASTROS</h2>
            <div class="card">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="openTab('tabFunc')">FUNCIONÁRIOS</button>
                    <button class="tab-btn" onclick="openTab('tabVeic')">VEÍCULOS</button>
                    <button class="tab-btn" onclick="openTab('tabCli')">CLIENTES</button>
                </div>

                <div id="tabFunc" class="tab-content active">
                    <div style="background:#e3f2fd; padding:15px; margin-bottom:15px; border-radius:5px;">
                        <i class="fas fa-info-circle"></i> <strong>Atenção:</strong> Ao salvar, o sistema criará automaticamente o LOGIN no Firebase.
                    </div>
                    <form id="formFunc">
                        <input type="hidden" id="funcId">
                        <div class="form-row">
                            <div class="form-col"><label>NOME COMPLETO:</label><input type="text" id="funcNome" required></div>
                            <div class="form-col"><label>FUNÇÃO:</label><select id="funcFuncao"><option value="motorista">MOTORISTA</option><option value="ajudante">AJUDANTE</option></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-col"><label>EMAIL (LOGIN):</label><input type="email" id="funcEmail" required></div>
                            <div class="form-col"><label>SENHA DE ACESSO:</label><input type="text" id="funcSenha" placeholder="Mínimo 6 caracteres (Obrigatório para novo)"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-col"><label>CPF:</label><input type="text" id="funcDoc"></div>
                            <div class="form-col"><label>TELEFONE:</label><input type="text" id="funcTel"></div>
                        </div>
                        <button type="submit" class="btn-primary">SALVAR E CRIAR LOGIN</button>
                    </form>
                </div>

                <div id="tabVeic" class="tab-content">
                    <form id="formVeic">
                        <div class="form-row">
                            <div class="form-col"><label>PLACA:</label><input type="text" id="veicPlaca" required></div>
                            <div class="form-col"><label>MODELO:</label><input type="text" id="veicModelo"></div>
                        </div>
                        <button type="submit" class="btn-primary">SALVAR VEÍCULO</button>
                    </form>
                    <table><thead><tr><th>PLACA</th><th>MODELO</th><th>AÇÃO</th></tr></thead><tbody id="listaVeiculos"></tbody></table>
                </div>

                <div id="tabCli" class="tab-content">
                    <form id="formCli">
                        <div class="form-row">
                            <div class="form-col"><label>RAZÃO SOCIAL:</label><input type="text" id="cliNome" required></div>
                            <div class="form-col"><label>CNPJ/ID:</label><input type="text" id="cliDoc" required></div>
                        </div>
                        <button type="submit" class="btn-primary">SALVAR CLIENTE</button>
                    </form>
                    <table><thead><tr><th>NOME</th><th>CNPJ</th><th>AÇÃO</th></tr></thead><tbody id="listaClientes"></tbody></table>
                </div>
            </div>
        </section>

        <section id="despesas" class="page">
            <h2>DESPESAS GERAIS</h2>
            <div class="card">
                <form id="formDespesa">
                    <div class="form-row">
                        <div class="form-col"><label>DATA:</label><input type="date" id="despData" required></div>
                        <div class="form-col"><label>DESCRIÇÃO:</label><input type="text" id="despDesc" required></div>
                        <div class="form-col"><label>VALOR (R$):</label><input type="number" step="0.01" id="despValor" required></div>
                    </div>
                    <button type="submit" class="btn-danger">LANÇAR DESPESA</button>
                </form>
                <table><thead><tr><th>DATA</th><th>DESCRIÇÃO</th><th>VALOR</th><th>AÇÃO</th></tr></thead><tbody id="tabelaDespesas"></tbody></table>
            </div>
        </section>

        <section id="relatorios" class="page">
            <h2>RELATÓRIOS & RECIBOS</h2>
            <div class="card">
                <div class="form-row">
                    <div class="form-col"><label>INÍCIO:</label><input type="date" id="relInicio"></div>
                    <div class="form-col"><label>FIM:</label><input type="date" id="relFim"></div>
                    <div class="form-col"><label>MOTORISTA:</label><select id="relMot"></select></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="gerarRelatorio()">GERAR RELATÓRIO GERAL</button>
                    <button class="btn-warning" onclick="gerarRecibo()">GERAR RECIBO DE PAGAMENTO</button>
                </div>
                <div id="areaRelatorio" style="margin-top:20px; padding:20px; border:1px solid #ccc; background:#fff; display:none;"></div>
                <button class="btn-secondary" style="margin-top:10px;" onclick="baixarPDF()">BAIXAR PDF</button>
            </div>
        </section>

        <section id="config" class="page">
            <h2>CONFIGURAÇÕES E BACKUP</h2>
            <div class="card">
                <h3>MANUTENÇÃO DE DADOS</h3>
                <p>Utilize estas opções para salvar seus dados ou restaurar em outro dispositivo.</p>
                <div style="display:flex; gap:15px; margin-top:15px;">
                    <button class="btn-primary" onclick="exportarBackup()"><i class="fas fa-download"></i> BAIXAR BACKUP (JSON)</button>
                    <label class="btn-secondary" style="cursor:pointer;">
                        <i class="fas fa-upload"></i> IMPORTAR BACKUP
                        <input type="file" style="display:none;" onchange="importarBackup(this)">
                    </label>
                </div>
            </div>
        </section>
        
        <section id="func-home" class="page">
            <h2>MEU PAINEL</h2>
            <div class="card"><p>Bem-vindo, <strong id="funcWelcome"></strong>.</p></div>
        </section>
        <section id="func-dados" class="page">
            <h2>MEUS DADOS</h2>
            <div class="card">
                <p>Para alterar dados sensíveis, contate o administrador.</p>
                <form id="formMeusDados">
                    <label>TELEFONE:</label><input type="text" id="meuTel">
                    <label>ENDEREÇO:</label><input type="text" id="meuEnd">
                    <button type="submit" class="btn-primary" style="margin-top:10px;">ATUALIZAR CONTATO</button>
                </form>
            </div>
        </section>

    </div>

    <div id="modalDetalhes" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="fecharModal()">&times;</span>
            <h3 id="modalTitulo">DETALHES</h3>
            <div id="modalCorpo"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // CONFIGURAÇÃO DO SEU PROJETO
        const firebaseConfig = {
            apiKey: "AIzaSyBZjVdcyjbEoR_-X6_lZuTRDMeN2wIntZI",
            authDomain: "logi-master-dd4cd.firebaseapp.com",
            projectId: "logi-master-dd4cd",
            storageBucket: "logi-master-dd4cd.firebasestorage.app",
            messagingSenderId: "673000154258",
            appId: "1:673000154258:web:fc9d6fced43e557076324b"
        };

        const app = initializeApp(firebaseConfig);
        
        // APP SECUNDÁRIA (PARA CRIAR USUÁRIOS SEM DESLOGAR O ADMIN)
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");

        const db = getFirestore(app);
        const auth = getAuth(app);

        // Exportar para o script.js
        window.dbRef = { 
            db, auth, doc, getDoc, setDoc, updateDoc, signOut, 
            secondaryAuth: getAuth(secondaryApp), 
            createUser: createUserWithEmailAndPassword 
        };

        // Auth Monitor
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    window.currentUser = snap.data();
                    document.body.style.display = 'flex';
                    document.getElementById('userEmailDisplay').textContent = window.currentUser.email;
                    document.getElementById('userRoleDisplay').textContent = window.currentUser.role;
                    
                    // Inicia o sistema
                    setTimeout(() => window.initSystem(window.currentUser), 100);
                } else {
                    alert("Usuário sem perfil!");
                    signOut(auth);
                }
            } else {
                window.location.href = "login.html";
            }
        });
    </script>
    <script src="script.js"></script>
</body>
</html>