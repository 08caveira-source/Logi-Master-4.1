<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>LOGIMASTER | GESTÃO DE FROTAS E LOGÍSTICA</title>
    
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body style="display:none;"> 
    
    <div class="mobile-nav">
        <button id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <span class="logo-mobile">
            LOGI<span style="color:var(--primary-color);">MASTER</span>
        </span>
    </div>

    <header class="sidebar" id="sidebar">
        <div class="logo">
            LOGI<span style="color:var(--primary-color);">MASTER</span>
        </div>

        <nav class="sidebar-menu">
            
            <div id="menu-admin" style="display:none;">
                <div class="nav-item active" data-page="home">
                    <i class="fas fa-th-large"></i> 
                    <span>DASHBOARD</span>
                </div>
                
                <div class="nav-item" data-page="operacoes">
                    <i class="fas fa-truck-loading"></i> 
                    <span>OPERAÇÕES / VIAGENS</span>
                </div>
                
                <div class="nav-item" data-page="checkins-pendentes">
                    <i class="fas fa-map-marked-alt"></i> 
                    <span>MONITORAMENTO ROTA</span>
                </div>
                
                <div class="nav-item" data-page="cadastros">
                    <i class="fas fa-database"></i> 
                    <span>CADASTROS BASE</span>
                </div>
                
                <div class="nav-item" data-page="despesas">
                    <i class="fas fa-wallet"></i> 
                    <span>DESPESAS GERAIS</span>
                </div>

                <div class="nav-item" data-page="recibos">
                    <i class="fas fa-file-invoice-dollar"></i> 
                    <span>RECIBOS & PAGAMENTOS</span>
                </div>
                
                <div class="nav-item" data-page="relatorios">
                    <i class="fas fa-chart-line"></i> 
                    <span>RELATÓRIOS & FATURAS</span>
                </div>
                
                <div class="nav-item" data-page="access-management">
                    <i class="fas fa-users-cog"></i> 
                    <span>EQUIPE & AVISOS</span>
                    <span id="badgeAccess" class="notification-badge" style="display:none;">0</span>
                </div>
                
                <div class="nav-item" data-page="configuracoes">
                    <i class="fas fa-cogs"></i> 
                    <span>CONFIGURAÇÕES</span>
                </div>
            </div>

            <div id="menu-employee" style="display:none;">
                <div class="nav-item" data-page="employee-home">
                    <i class="fas fa-route"></i> 
                    <span>MINHAS VIAGENS</span>
                </div>
                
                <div class="nav-item" data-page="employee-historico">
                    <i class="fas fa-history"></i> 
                    <span>MEU HISTÓRICO</span>
                </div>
                
                <div class="nav-item" data-page="recibos">
                    <i class="fas fa-file-contract"></i> 
                    <span>MEUS RECIBOS</span>
                </div>
                
                <div class="nav-item" data-page="meus-dados">
                    <i class="fas fa-user-edit"></i> 
                    <span>MEUS DADOS</span>
                </div>
            </div>

            <div id="menu-super-admin" style="display:none;">
                <div class="nav-item" data-page="super-admin">
                    <i class="fas fa-globe"></i> 
                    <span>VISÃO GLOBAL (SUPER)</span>
                </div>
            </div>

        </nav>

        <div class="user-profile-widget">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="background:#009688; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                    <i class="fas fa-user"></i>
                </div>
                <div style="overflow:hidden;">
                    <div id="userEmailDisplay" style="font-weight:bold; font-size:0.8rem; overflow:hidden; text-overflow:ellipsis;">---</div>
                    <div id="userRoleDisplay" style="font-size:0.7rem; color:#b0bec5;">---</div>
                </div>
            </div>
            <button onclick="logoutSystem()" style="width:100%; margin-top:15px; background:transparent; border:1px solid #ff5252; color:#ff5252; border-radius:4px; padding:5px; cursor:pointer;">
                <i class="fas fa-sign-out-alt"></i> SAIR
            </button>
        </div>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <main class="main-content">
        
        <section id="home" class="page active">
            <h2>DASHBOARD OPERACIONAL</h2>
            
            <div class="dashboard-grid">
                <div class="card-stat green">
                    <span class="label">FATURAMENTO (MÊS)</span>
                    <span class="value" id="faturamentoMes">R$ 0,00</span>
                    <i class="fas fa-dollar-sign icon-bg"></i>
                </div>
                <div class="card-stat red">
                    <span class="label">CUSTOS TOTAIS</span>
                    <span class="value" id="despesasMes">R$ 0,00</span>
                    <i class="fas fa-arrow-down icon-bg"></i>
                </div>
                <div class="card-stat blue">
                    <span class="label">LUCRO LÍQUIDO</span>
                    <span class="value" id="receitaMes">R$ 0,00</span>
                    <i class="fas fa-chart-pie icon-bg"></i>
                </div>
                <div class="card-stat orange">
                    <span class="label">MARGEM MÉDIA</span>
                    <span class="value" id="margemLucroMedia">0%</span>
                    <i class="fas fa-percent icon-bg"></i>
                </div>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
                
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">CALENDÁRIO DE VIAGENS</h3>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button class="btn-mini btn-secondary" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span id="currentMonthYear" style="font-weight:bold; min-width:120px; text-align:center;">MÊS/ANO</span>
                            <button class="btn-mini btn-secondary" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-grid-header" style="display:grid; grid-template-columns: repeat(7, 1fr);">
                            <div class="day-header">DOM</div>
                            <div class="day-header">SEG</div>
                            <div class="day-header">TER</div>
                            <div class="day-header">QUA</div>
                            <div class="day-header">QUI</div>
                            <div class="day-header">SEX</div>
                            <div class="day-header">SAB</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 15px; font-size: 0.8rem; color:#666;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:green; border-radius:50%;"></div> Finalizada
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:orange; border-radius:50%;"></div> Em Rota
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:10px; height:10px; background:#999; border-radius:50%;"></div> Agendada
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>ANÁLISE FINANCEIRA</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.8rem;">Filtrar Gráfico por Veículo:</label>
                        <select id="filtroVeiculoGrafico" onchange="atualizarDashboard()" style="width:100%; padding:5px;">
                            <option value="">TODOS OS VEÍCULOS</option>
                        </select>
                    </div>

                    <div style="height: 300px; position: relative;">
                        <canvas id="mainChart"></canvas>
                    </div>
                    
                    <div id="destaqueFinanceiroGrafico" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                        </div>
                </div>
            </div>
        </section>

        <section id="operacoes" class="page">
            <h2>GESTÃO DE OPERAÇÕES E VIAGENS</h2>
            
            <div class="card">
                <form id="formOperacao">
                    <input type="hidden" id="operacaoId">
                    
                    <div class="form-grid">
                        <div class="form-col">
                            <label>Data da Viagem</label>
                            <input type="date" id="operacaoData" required>
                        </div>
                        <div class="form-col">
                            <label>Motorista Responsável</label>
                            <select id="selectMotoristaOperacao" required>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Veículo Utilizado</label>
                            <select id="selectVeiculoOperacao" required>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grid" style="margin-top:15px;">
                        <div class="form-col">
                            <label>Cliente / Empresa Contratante</label>
                            <select id="selectContratanteOperacao" required>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Tipo de Serviço / Atividade</label>
                            <select id="selectAtividadeOperacao" required>
                                <option value="">Carregando...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Valor de Faturamento (R$)</label>
                            <input type="number" id="operacaoFaturamento" step="0.01" required placeholder="0.00">
                        </div>
                    </div>

                    <div style="margin-top:20px; padding:20px; background:#f9f9f9; border-radius:8px; border:1px solid #ddd;">
                        <h4 style="margin:0 0 10px 0; color:var(--secondary-color);">
                            <i class="fas fa-users"></i> EQUIPE DE AJUDANTES
                        </h4>
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <div style="flex:2;">
                                <label>Selecionar Ajudante da Lista</label>
                                <select id="selectAjudantesOperacao">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <button type="button" class="btn-primary" id="btnManualAddAjudante" style="height: 40px;">
                                <i class="fas fa-plus"></i> ADICIONAR
                            </button>
                        </div>
                        <div id="containerAjudantesLista" style="margin-top:15px;">
                            <ul id="listaAjudantesAdicionados" style="list-style:none; padding:0; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                </ul>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-top:20px;">
                        <div class="form-col">
                            <label>Valor Adiantamento (R$)</label>
                            <input type="number" id="operacaoAdiantamento" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-col">
                            <label>Comissão do Motorista (R$)</label>
                            <input type="number" id="operacaoComissao" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="form-col" style="display:flex; align-items:center; gap:15px; padding-top:25px;">
                            <div style="display:flex; align-items:center; gap:5px; background:#fff3e0; padding:10px; border-radius:5px; border:1px solid #ffe0b2;">
                                <input type="checkbox" id="operacaoIsAgendamento" style="width:auto; margin:0;"> 
                                <label for="operacaoIsAgendamento" style="margin:0; font-size:0.85rem; cursor:pointer;">Agendar Futuramente</label>
                            </div>
                            <button type="submit" class="btn-success" style="flex:1; height:45px; font-size:1rem;">
                                <i class="fas fa-save"></i> GRAVAR VIAGEM
                            </button>
                        </div>
                    </div>
                    
                    <div style="display:none;">
                        <input type="number" id="operacaoKmRodado">
                        <input type="number" id="operacaoCombustivel">
                        <input type="number" id="operacaoPrecoLitro">
                        <input type="number" id="operacaoDespesas">
                    </div>
                </form>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>HISTÓRICO RECENTE DE OPERAÇÕES</h3>
                    <div style="font-size:0.8rem; color:#666;">
                        <i class="fas fa-info-circle"></i> Mostrando últimas atualizações
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="data-table" id="tabelaOperacoes">
                        <thead>
                            <tr>
                                <th style="width:100px;">DATA</th>
                                <th>MOTORISTA / VEÍCULO</th>
                                <th>STATUS</th>
                                <th>FATURAMENTO</th>
                                <th style="width:150px;">AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="checkins-pendentes" class="page">
            <h2>MONITORAMENTO DE FROTA & EQUIPE</h2>
            
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:var(--primary-color);">
                        <i class="fas fa-satellite-dish"></i> ROTAS EM ANDAMENTO / AGENDADAS
                    </h3>
                    <button class="btn-mini btn-secondary" onclick="sincronizarDadosDaNuvem(true)">
                        <i class="fas fa-sync"></i> ATUALIZAR AGORA
                    </button>
                </div>
                
                <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">
                    Acompanhe aqui o status de check-in da equipe e o início das viagens em tempo real.
                </p>

                <div class="table-responsive">
                    <table class="data-table" id="tabelaCheckinsPendentes">
                        <thead>
                            <tr>
                                <th>DATA</th>
                                <th>VEÍCULO</th>
                                <th>EQUIPE & STATUS CHECK-IN</th>
                                <th>STATUS ROTA</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="border-top: 4px solid var(--danger-color);">
                <h3 style="color:var(--danger-color);">
                    <i class="fas fa-exclamation-triangle"></i> OCORRÊNCIAS / FALTAS REGISTADAS
                </h3>
                <div class="table-responsive">
                    <table class="data-table" id="tabelaFaltas">
                        <thead>
                            <tr>
                                <th>DATA</th>
                                <th>FUNCIONÁRIO</th>
                                <th>FUNÇÃO</th>
                                <th>MOTIVO</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="cadastros" class="page">
            <h2>GESTÃO DE CADASTROS</h2>
            
            <div class="cadastro-tabs">
                <button class="cadastro-tab-btn active" data-tab="tab-funcionarios">
                    <i class="fas fa-user-tie"></i> FUNCIONÁRIOS
                </button>
                <button class="cadastro-tab-btn" data-tab="tab-veiculos">
                    <i class="fas fa-truck"></i> VEÍCULOS
                </button>
                <button class="cadastro-tab-btn" data-tab="tab-contratantes">
                    <i class="fas fa-building"></i> CLIENTES
                </button>
                <button class="cadastro-tab-btn" data-tab="tab-atividades">
                    <i class="fas fa-clipboard-list"></i> SERVIÇOS
                </button>
            </div>

            <div id="tab-funcionarios" class="cadastro-form active">
                <div class="card">
                    <h3 style="margin-top:0;">NOVO FUNCIONÁRIO</h3>
                    <form id="formFuncionario">
                        <input type="hidden" id="funcionarioId">
                        
                        <div class="form-grid">
                            <div class="form-col">
                                <label>Nome Completo</label>
                                <input type="text" id="funcNome" required placeholder="Ex: João da Silva">
                            </div>
                            <div class="form-col">
                                <label>Função / Cargo</label>
                                <select id="funcFuncao" onchange="toggleDriverFields()" required>
                                    <option value="motorista">MOTORISTA</option>
                                    <option value="ajudante">AJUDANTE</option>
                                    <option value="admin">ADMINISTRADOR</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label>E-mail (Login de Acesso)</label>
                                <input type="email" id="funcEmail" required placeholder="email@exemplo.com">
                            </div>
                        </div>

                        <div class="form-grid" style="margin-top:15px;">
                            <div class="form-col">
                                <label>Telefone / WhatsApp</label>
                                <input type="text" id="funcTelefone" placeholder="(00) 00000-0000">
                            </div>
                            <div class="form-col">
                                <label>CPF / Documento</label>
                                <input type="text" id="funcDocumento" placeholder="000.000.000-00">
                            </div>
                            <div class="form-col">
                                <label>Senha de Acesso (Login)</label>
                                <input type="password" id="funcSenha" placeholder="Deixe vazio se não quiser alterar">
                            </div>
                        </div>

                        <div id="driverSpecificFields" style="display:none; margin-top:20px; background:#e0f2f1; padding:20px; border-radius:8px; border:1px solid #b2dfdb;">
                            <h4 style="margin-top:0; color:#00695c;"><i class="fas fa-id-card"></i> DADOS DA HABILITAÇÃO (CNH)</h4>
                            <div class="form-grid">
                                <div class="form-col">
                                    <label>Número de Registro CNH</label>
                                    <input type="text" id="funcCNH">
                                </div>
                                <div class="form-col">
                                    <label>Validade da CNH</label>
                                    <input type="date" id="funcValidadeCNH">
                                </div>
                                <div class="form-col">
                                    <label>Categoria</label>
                                    <input type="text" id="funcCategoriaCNH" placeholder="Ex: AD, AE">
                                </div>
                            </div>
                            <div style="margin-top:15px;">
                                <label>Cursos (MOPP, etc) / Observações</label>
                                <textarea id="funcCursoDescricao" rows="2" style="width:100%; padding:10px;"></textarea>
                            </div>
                        </div>

                        <div class="form-grid" style="margin-top:15px;">
                            <div class="form-col">
                                <label>Chave PIX (Para Pagamentos)</label>
                                <input type="text" id="funcPix">
                            </div>
                            <div class="form-col" style="flex:2;">
                                <label>Endereço Residencial Completo</label>
                                <input type="text" id="funcEndereco">
                            </div>
                        </div>

                        <div style="margin-top:20px; text-align:right;">
                            <button type="submit" class="btn-success" style="padding:12px 30px;">
                                <i class="fas fa-save"></i> SALVAR FUNCIONÁRIO
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3>LISTA DE FUNCIONÁRIOS</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaFuncionarios">
                            <thead>
                                <tr>
                                    <th>NOME</th>
                                    <th>FUNÇÃO</th>
                                    <th>E-MAIL</th>
                                    <th>AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="tab-veiculos" class="cadastro-form">
                <div class="card">
                    <h3>CADASTRAR VEÍCULO</h3>
                    <form id="formVeiculo">
                        <div class="form-grid">
                            <div class="form-col">
                                <label>Placa do Veículo</label>
                                <input type="text" id="veiculoPlaca" required placeholder="ABC-1234">
                            </div>
                            <div class="form-col">
                                <label>Modelo / Marca</label>
                                <input type="text" id="veiculoModelo" required placeholder="Ex: Scania R450">
                            </div>
                            <div class="form-col">
                                <label>Ano de Fabricação</label>
                                <input type="number" id="veiculoAno" placeholder="2020">
                            </div>
                        </div>
                        <div class="form-grid" style="margin-top:15px;">
                            <div class="form-col">
                                <label>Código Renavam</label>
                                <input type="text" id="veiculoRenavam">
                            </div>
                            <div class="form-col">
                                <label>Chassi</label>
                                <input type="text" id="veiculoChassi">
                            </div>
                            <div class="form-col" style="display:flex; align-items:flex-end;">
                                <button type="submit" class="btn-success" style="width:100%;">
                                    <i class="fas fa-save"></i> SALVAR VEÍCULO
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3>FROTA CADASTRADA</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaVeiculos">
                            <thead>
                                <tr>
                                    <th>PLACA</th>
                                    <th>MODELO</th>
                                    <th>ANO</th>
                                    <th>AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-contratantes" class="cadastro-form">
                <div class="card">
                    <h3>CADASTRAR CLIENTE</h3>
                    <form id="formContratante">
                        <div class="form-grid">
                            <div class="form-col">
                                <label>Razão Social / Nome do Cliente</label>
                                <input type="text" id="contratanteRazaoSocial" required>
                            </div>
                            <div class="form-col">
                                <label>CNPJ / CPF</label>
                                <input type="text" id="contratanteCNPJ" required>
                            </div>
                        </div>
                        <div class="form-grid" style="margin-top:15px;">
                            <div class="form-col">
                                <label>Telefone de Contato</label>
                                <input type="text" id="contratanteTelefone">
                            </div>
                            <div class="form-col" style="display:flex; align-items:flex-end;">
                                <button type="submit" class="btn-success" style="width:100%;">
                                    <i class="fas fa-save"></i> SALVAR CLIENTE
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3>CARTEIRA DE CLIENTES</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaContratantes">
                            <thead>
                                <tr>
                                    <th>NOME / RAZÃO SOCIAL</th>
                                    <th>CNPJ</th>
                                    <th>TELEFONE</th>
                                    <th>AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-atividades" class="cadastro-form">
                <div class="card">
                    <h3>CADASTRAR TIPO DE SERVIÇO</h3>
                    <form id="formAtividade">
                        <input type="hidden" id="atividadeId">
                        <div class="form-grid">
                            <div class="form-col" style="flex:3;">
                                <label>Nome do Serviço / Atividade (Ex: Frete Local, Viagem Longa)</label>
                                <input type="text" id="atividadeNome" required>
                            </div>
                            <div class="form-col" style="display:flex; align-items:flex-end;">
                                <button type="submit" class="btn-success" style="width:100%;">
                                    <i class="fas fa-save"></i> SALVAR SERVIÇO
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3>SERVIÇOS DISPONÍVEIS</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaAtividades">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>NOME DO SERVIÇO</th>
                                    <th>AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="despesas" class="page">
            <h2>GESTÃO DE DESPESAS GERAIS</h2>
            
            <div class="card">
                <h3>LANÇAR NOVA DESPESA</h3>
                <form id="formDespesaGeral">
                    <div class="form-grid">
                        <div class="form-col">
                            <label>Data da Despesa</label>
                            <input type="date" id="despesaGeralData" required>
                        </div>
                        <div class="form-col">
                            <label>Vínculo com Veículo (Opcional)</label>
                            <select id="selectVeiculoDespesaGeral">
                                <option value="">Sem vínculo (Geral)</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Descrição (Ex: Aluguel, Peças)</label>
                            <input type="text" id="despesaGeralDescricao" required>
                        </div>
                        <div class="form-col">
                            <label>Valor Total (R$)</label>
                            <input type="number" id="despesaGeralValor" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-grid" style="margin-top:15px;">
                        <div class="form-col">
                            <label>Forma de Pagamento</label>
                            <select id="despesaFormaPagamento">
                                <option value="pix">PIX</option>
                                <option value="dinheiro">DINHEIRO</option>
                                <option value="cartao">CARTÃO DE CRÉDITO/DÉBITO</option>
                                <option value="boleto">BOLETO BANCÁRIO</option>
                                <option value="transferencia">TED/DOC</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Condição de Pagamento</label>
                            <select id="despesaModoPagamento" onchange="toggleDespesaParcelas()">
                                <option value="vista">À VISTA</option>
                                <option value="parcelado">PARCELADO</option>
                            </select>
                        </div>
                        
                        <div id="divDespesaParcelas" class="form-col" style="display:none; gap:10px;">
                            <div style="flex:1;">
                                <label>Total Parcelas</label>
                                <input type="number" id="despesaParcelas" value="1" min="1">
                            </div>
                            <div style="flex:1;">
                                <label>Pagas</label>
                                <input type="number" id="despesaParcelasPagas" value="0" min="0">
                            </div>
                        </div>

                        <div class="form-col" style="display:flex; align-items:flex-end;">
                            <button type="submit" class="btn-danger" style="width:100%;">
                                <i class="fas fa-minus-circle"></i> LANÇAR DESPESA
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <h3>HISTÓRICO DE DESPESAS</h3>
                <div class="table-responsive">
                    <table class="data-table" id="tabelaDespesasGerais">
                        <thead>
                            <tr>
                                <th>DATA</th>
                                <th>VEÍCULO</th>
                                <th>DESCRIÇÃO</th>
                                <th>VALOR</th>
                                <th>MODO</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="recibos" class="page">
            <h2>RECIBOS & PAGAMENTOS</h2>
            
            <div id="adminRecibosPanel">
                <div class="card">
                    <h3>GERAR RECIBO DE PAGAMENTO</h3>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">
                        Selecione o funcionário e o período para calcular automaticamente comissões e diárias.
                    </p>
                    <div class="form-grid">
                        <div class="form-col">
                            <label>Selecionar Funcionário</label>
                            <select id="selectMotoristaRecibo"></select>
                        </div>
                        <div class="form-col">
                            <label>Data Início (Período)</label>
                            <input type="date" id="dataInicioRecibo">
                        </div>
                        <div class="form-col">
                            <label>Data Fim (Período)</label>
                            <input type="date" id="dataFimRecibo">
                        </div>
                        <div class="form-col" style="display:flex; align-items:flex-end;">
                            <button class="btn-primary" onclick="gerarReciboPagamento()" style="width:100%;">
                                <i class="fas fa-calculator"></i> CALCULAR E GERAR
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>HISTÓRICO DE RECIBOS EMITIDOS</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaHistoricoRecibos">
                            <thead>
                                <tr>
                                    <th>EMISSÃO</th>
                                    <th>FUNCIONÁRIO</th>
                                    <th>PERÍODO REF.</th>
                                    <th>VALOR TOTAL</th>
                                    <th>ENVIADO?</th>
                                    <th>AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="employeeRecibosPanel" style="display:none;">
                <div class="card">
                    <h3>MEUS RECIBOS DE PAGAMENTO</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaMeusRecibos">
                            <thead>
                                <tr>
                                    <th>DATA EMISSÃO</th>
                                    <th>PERÍODO DE REFERÊNCIA</th>
                                    <th>VALOR LÍQUIDO</th>
                                    <th>VISUALIZAR</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="relatorios" class="page">
            <h2>CENTRAL DE RELATÓRIOS E FATURAMENTO</h2>
            
            <div class="card">
                <h3>FILTROS DE RELATÓRIO</h3>
                <div class="form-grid">
                    <div class="form-col">
                        <label>Data Inicial</label>
                        <input type="date" id="dataInicioRelatorio">
                    </div>
                    <div class="form-col">
                        <label>Data Final</label>
                        <input type="date" id="dataFimRelatorio">
                    </div>
                    <div class="form-col">
                        <label>Filtrar por Funcionário</label>
                        <select id="selectMotoristaRelatorio">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid" style="margin-top:15px;">
                    <div class="form-col">
                        <label>Filtrar por Veículo</label>
                        <select id="selectVeiculoRelatorio">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Filtrar por Cliente</label>
                        <select id="selectContratanteRelatorio">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Tipo de Serviço</label>
                        <select id="selectAtividadeRelatorio">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:25px; display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="gerarRelatorioGeral()">
                        <i class="fas fa-file-alt"></i> RELATÓRIO GERAL / LUCRO
                    </button>
                    <button class="btn-success" onclick="gerarRelatorioCobranca()">
                        <i class="fas fa-file-invoice"></i> FATURA DE SERVIÇOS (CLIENTE)
                    </button>
                    <button class="btn-secondary" onclick="exportarRelatorioPDF()">
                        <i class="fas fa-file-pdf"></i> EXPORTAR RESULTADO (PDF)
                    </button>
                </div>
            </div>

            <div id="reportResults" class="card" style="display:none; border: 1px solid #ccc; min-height:400px;">
                <div id="reportContent" style="padding:20px;">
                    </div>
            </div>
        </section>

        <section id="access-management" class="page">
            <h2>GESTÃO DE EQUIPE E ACESSOS</h2>
            
            <div class="dashboard-grid">
                <div class="card" style="border-top: 5px solid var(--warning-color);">
                    <h3 style="color:var(--warning-color);">
                        <i class="fas fa-user-clock"></i> PENDENTES DE APROVAÇÃO
                    </h3>
                    <p style="font-size:0.85rem; color:#666;">
                        Novos cadastros que aguardam permissão para acessar o sistema.
                    </p>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaCompanyPendentes">
                            <thead>
                                <tr>
                                    <th>NOME</th>
                                    <th>E-MAIL</th>
                                    <th>CARGO</th>
                                    <th>STATUS</th>
                                    <th>AÇÃO</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="border-top: 5px solid var(--success-color);">
                    <h3 style="color:var(--success-color);">
                        <i class="fas fa-users"></i> LISTA DE FUNCIONÁRIOS ATIVOS
                    </h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabelaCompanyAtivos">
                            <thead>
                                <tr>
                                    <th>NOME</th>
                                    <th>E-MAIL</th>
                                    <th>CARGO</th>
                                    <th>STATUS</th>
                                    <th>AÇÃO</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>SOLICITAÇÕES DE ALTERAÇÃO DE PERFIL</h3>
                <div class="table-responsive">
                    <table class="data-table" id="tabelaProfileRequests">
                        <thead>
                            <tr>
                                <th>DATA</th>
                                <th>FUNCIONÁRIO</th>
                                <th>CAMPO</th>
                                <th>NOVO VALOR</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>ENVIAR MENSAGEM / AVISO PARA A EQUIPE</h3>
                <div class="form-grid">
                    <div class="form-col" style="flex:2;">
                        <input type="text" id="msgContentInput" placeholder="Digite o aviso aqui...">
                    </div>
                    <div class="form-col">
                        <select id="msgRecipientSelect">
                            <option value="all">TODOS</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn-primary" onclick="enviarMensagemEquipe()" style="width:100%;">
                            <i class="fas fa-paper-plane"></i> ENVIAR
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="configuracoes" class="page">
            <h2>CONFIGURAÇÕES DO SISTEMA</h2>
            
            <div class="card">
                <h3>DADOS DA MINHA EMPRESA (PARA RELATÓRIOS/RECIBOS)</h3>
                <form id="formMinhaEmpresa">
                    <div class="form-grid">
                        <div class="form-col">
                            <label>Razão Social</label>
                            <input type="text" id="minhaEmpresaRazaoSocial">
                        </div>
                        <div class="form-col">
                            <label>CNPJ</label>
                            <input type="text" id="minhaEmpresaCNPJ">
                        </div>
                        <div class="form-col">
                            <label>Telefone</label>
                            <input type="text" id="minhaEmpresaTelefone">
                        </div>
                        <div class="form-col" style="display:flex; align-items:flex-end;">
                            <button type="submit" class="btn-success" style="width:100%;">
                                <i class="fas fa-save"></i> ATUALIZAR DADOS
                            </button>
                        </div>
                    </div>
                </form>
                <div id="viewMinhaEmpresaContent" style="margin-top:15px; padding:15px; background:#f1f8e9; border:1px solid #c8e6c9; border-radius:4px;">
                    </div>
            </div>

            <div class="card">
                <h3>BACKUP E MANUTENÇÃO DE DADOS</h3>
                <p style="color:#666; font-size:0.9rem;">
                    Faça download dos seus dados regularmente para evitar perdas.
                </p>
                <div style="display:flex; gap:15px; flex-wrap:wrap; margin-top:15px;">
                    <button class="btn-secondary" onclick="exportDataBackup()">
                        <i class="fas fa-download"></i> EXPORTAR BACKUP (JSON)
                    </button>
                    
                    <button class="btn-secondary" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload"></i> IMPORTAR BACKUP
                    </button>
                    <input type="file" id="importFile" style="display:none;" onchange="importDataBackup(event)">
                    
                    <button class="btn-danger" onclick="resetSystemData()" style="margin-left:auto;">
                        <i class="fas fa-trash-alt"></i> ZERAR TODO O SISTEMA
                    </button>
                </div>
            </div>
        </section>

        <section id="employee-home" class="page">
            <h2>MINHAS VIAGENS AGENDADAS</h2>
            <div id="listaServicosAgendados">
                </div>
        </section>

        <section id="employee-historico" class="page">
            <h2>MEU HISTÓRICO DE SERVIÇOS</h2>
            <div class="card">
                <div class="form-grid">
                    <div class="form-col"><label>De:</label><input type="date" id="empDataInicio"></div>
                    <div class="form-col"><label>Até:</label><input type="date" id="empDataFim"></div>
                    <div class="form-col" style="display:flex; align-items:flex-end;">
                        <button class="btn-primary" onclick="filtrarHistoricoFuncionario()">
                            <i class="fas fa-filter"></i> FILTRAR
                        </button>
                    </div>
                </div>
            </div>
            <div class="card">
                <table class="data-table" id="tabelaHistoricoCompleto">
                    <thead>
                        <tr>
                            <th>DATA</th>
                            <th>VEÍCULO</th>
                            <th>CLIENTE</th>
                            <th>VALOR</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="text-align:right; font-size:1.2rem; font-weight:bold; margin-top:15px;">
                    TOTAL A RECEBER: <span id="empTotalReceber" style="color:green;">R$ 0,00</span>
                </div>
            </div>
        </section>

        <section id="meus-dados" class="page">
            </section>

        <section id="super-admin" class="page">
            <h2>PAINEL DE CONTROLO GLOBAL (SUPER ADMIN)</h2>
            <div class="super-search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="superAdminSearch" placeholder="Pesquisar por empresa ou administrador..." onkeyup="filterGlobalUsers()" style="border:none; margin-left:10px; flex:1;">
                <button class="btn-secondary btn-mini" onclick="carregarPainelSuperAdmin(true)">
                    <i class="fas fa-sync"></i> ATUALIZAR
                </button>
            </div>
            <div id="superAdminContainer" class="hierarchy-container">
                <p style="text-align:center; padding:50px; color:#666;">Carregando dados globais...</p>
            </div>
        </section>

    </main>

    <div id="modalManageCredits" class="modal-overlay">
        <div class="modal-content">
            <h3>GERENCIAR ASSINATURA & CRÉDITOS</h3>
            <div id="manageCreditBody"></div>
            <div style="margin-top:15px; text-align:right;">
                <button class="btn-secondary" onclick="document.getElementById('modalManageCredits').style.display='none'">FECHAR</button>
            </div>
        </div>
    </div>

    <div id="modalDayOperations" class="modal-overlay">
        <div class="modal-content" style="max-width:950px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="modalDayTitle" style="margin:0;">DETALHES DO DIA</h3>
                <button class="btn-mini btn-danger" onclick="document.getElementById('modalDayOperations').style.display='none'">X</button>
            </div>
            <div id="modalDaySummary"></div>
            <div id="modalDayBody"></div>
        </div>
    </div>

    <div id="viewItemModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="viewItemTitle">VISUALIZAÇÃO</h3>
            <div id="viewItemBody" style="margin:20px 0;"></div>
            <button class="btn-secondary" onclick="closeViewModal()" style="width:100%;">FECHAR</button>
        </div>
    </div>

    <div id="modalNotification" class="modal-overlay">
        <div class="modal-content" style="border-top: 10px solid var(--primary-color);">
            <h3 style="color:var(--primary-color);"><i class="fas fa-bell"></i> NOVO AVISO</h3>
            <p id="notificationMessageText" style="font-size:1.1rem; padding:15px 0; border-bottom:1px solid #eee;"></p>
            <p id="notificationSender" style="font-size:0.8rem; color:#666;"></p>
            <button class="btn-primary" onclick="confirmarLeituraMensagem()" style="width:100%; margin-top:15px;">LIDO E COMPREENDIDO</button>
        </div>
    </div>

    <div id="modalRequestProfileChange" class="modal-overlay">
        <div class="modal-content">
            <h3>SOLICITAR ALTERAÇÃO DE DADOS</h3>
            <form id="formRequestProfileChange">
                <label>Qual dado deseja alterar?</label>
                <select id="reqFieldType" required>
                    <option value="TELEFONE">TELEFONE</option>
                    <option value="PIX">CHAVE PIX</option>
                    <option value="ENDERECO">ENDEREÇO</option>
                    <option value="CNH">Nº CNH (MOTORISTA)</option>
                    <option value="VALIDADE_CNH">VALIDADE CNH (MOTORISTA)</option>
                </select>
                <label style="margin-top:10px;">Novo Valor:</label>
                <input type="text" id="reqNewValue" required>
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('modalRequestProfileChange').style.display='none'">CANCELAR</button>
                    <button type="submit" class="btn-success">ENVIAR</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalRecibo" class="modal-overlay">
        <div class="modal-content" style="max-width:800px;">
            <div id="modalReciboContent"></div>
            <div id="modalReciboActions" style="margin-top:20px; display:flex; gap:10px; justify-content:center;"></div>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      // Configuração Firebase (Suas Chaves)
      const firebaseConfig = {
        apiKey: "AIzaSyBZjVdcyjbEoR_-X6_lZuTRDMeN2wIntZI",
        authDomain: "logi-master-dd4cd.firebaseapp.com",
        projectId: "logi-master-dd4cd",
        storageBucket: "logi-master-dd4cd.firebasestorage.app",
        messagingSenderId: "673000154258",
        appId: "1:673000154258:web:fc9d6fced43e557076324b"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Função Auxiliar para Criar Usuário (Secundário)
      async function criarUsuarioSecundario(email, senha) {
          const appSec = initializeApp(firebaseConfig, "Secondary");
          const authSec = getAuth(appSec);
          const res = await createUserWithEmailAndPassword(authSec, email, senha);
          await signOut(authSec);
          return res.user.uid;
      }

      // Expõe referências para o script.js
      window.dbRef = { 
          db, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc, auth,
          criarAuthUsuario: criarUsuarioSecundario 
      };

      // Observador de Autenticação
      onAuthStateChanged(auth, async (user) => {
          if (user) {
              const userRef = doc(db, "users", user.uid);
              const userSnap = await getDoc(userRef);
              
              if (userSnap.exists()) {
                  const userData = userSnap.data();
                  
                  // 1. Verificação de Aprovação
                  if (userData.email !== 'admin@logimaster.com' && userData.approved === false) {
                      alert("CONTA AGUARDANDO APROVAÇÃO.\n\nAguarde liberação do administrador.");
                      await signOut(auth);
                      window.location.replace("login.html");
                      return;
                  }

                  // 2. Verificação de Licença (SaaS)
                  if (userData.email !== 'admin@logimaster.com') {
                        const companyRef = doc(db, "companies", userData.company);
                        const companySnap = await getDoc(companyRef);
                        if (companySnap.exists()) {
                            const cData = companySnap.data();
                            const agora = new Date();
                            const validade = cData.validade ? new Date(cData.validade) : new Date(0);
                            
                            if (cData.vitalicio !== true && agora > validade) {
                                alert("ACESSO BLOQUEADO: LICENÇA EXPIRADA.\nContate o administrador para renovação.");
                                await signOut(auth);
                                window.location.replace("login.html");
                                return;
                            }
                        }
                  }

                  window.currentUser = userData; 
                  document.body.style.display = 'flex'; 
                  
                  const emailElem = document.getElementById('userEmailDisplay');
                  const roleElem = document.getElementById('userRoleDisplay');
                  if(emailElem) emailElem.textContent = userData.email.toUpperCase();
                  if(roleElem) roleElem.textContent = userData.role.toUpperCase();
                  
                  setTimeout(() => { 
                      if (window.initSystemByRole) window.initSystemByRole(userData); 
                  }, 500);

              } else {
                  await signOut(auth);
                  window.location.replace("login.html");
              }
          } else { 
              if(!window.location.href.includes('login.html')) {
                  window.location.replace("login.html"); 
              }
          }
      });
      
      window.logoutSystem = async function() {
          if(confirm("Deseja realmente sair do sistema?")) {
              await signOut(auth);
              window.location.href = "login.html";
          }
      }
    </script>

    <script src="script.js" defer></script>
</body>
</html>